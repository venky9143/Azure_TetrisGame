name: Tetris-Gane CICD

on:
  push:
    branches: main

permissions:
  id-token: write
  contents: read

jobs:
  docker_login:
    runs-on: self-hosted
    steps:
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUBUSERNAME }}
          password: ${{ secrets.DOCKERHUBPASSWORD }}
      -    
        name: Verifying Login
        run: echo "Login Is sucessful"

      - 
        name: Listing Docker Images
        run: |
           echo "Docker images list"
           docker images
        
      - 
        name: check the images and pull if not present !!!!
        run: |

          echo " Checcking for Docker images pull the image if it's not present"
          
          IMAGE_NAME="venkateshkesa/tetris:latest"

          if docker images | grep -q "${IMAGE_NAME}"; then
            echo "Image ${IMAGE_NAME} is already present."
          else
            echo "Image ${IMAGE_NAME} is not present. Pulling the image..."
            docker pull ${IMAGE_NAME}
          fi
          echo "displaying the docker images"
          docker images

  azure_login:
    runs-on: self-hosted
    needs: docker_login
    steps:
      -
        name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          auth-type: OIDC

      - name: Verifying Login
        run: echo "Login Is sucessful"

      - name: Verify Azure Login & Subscription
        run: |
         echo "âœ… Logged into Azure"
         az account show

